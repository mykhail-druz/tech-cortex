# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏ PaymentIntent

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### 1. API Endpoints
- ‚úÖ `/api/stripe/create-payment-intent` - —Å–æ–∑–¥–∞–Ω–∏–µ PaymentIntent
- ‚úÖ `/api/stripe/update-payment-intent` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ PaymentIntent
- ‚úÖ `/api/stripe/calculate-tax` - —Ä–∞—Å—á–µ—Ç –Ω–∞–ª–æ–≥–æ–≤

### 2. –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã
1. **PaymentIntent —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞ –Ω–∞–ª–æ–≥–æ–≤**
2. **PaymentIntent –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞–ª–æ–≥–æ–≤**
3. **PaymentIntent —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ**

### 3. –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è
- üîµ "Calculating taxes..." - —Ä–∞—Å—á–µ—Ç –Ω–∞–ª–æ–≥–æ–≤
- üü† "Updating payment amount..." - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ PaymentIntent
- üü¢ "Payment ready" - –≥–æ—Ç–æ–≤ –∫ –æ–ø–ª–∞—Ç–µ
- ‚ö™ "Please complete your address to continue" - –Ω—É–∂–µ–Ω –∞–¥—Ä–µ—Å

## –°—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ë–∞–∑–æ–≤—ã–π —Ñ–ª–æ—É
1. –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –∑–∞ $1.00 –≤ –∫–æ—Ä–∑–∏–Ω—É
2. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ checkout
3. **–û–∂–∏–¥–∞–µ–º–æ**: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è "Please complete your address to continue"
4. –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–¥—Ä–µ—Å –≤ California
5. **–û–∂–∏–¥–∞–µ–º–æ**: "Calculating taxes..." ‚Üí –Ω–∞–ª–æ–≥ 7% ‚Üí "Payment ready"
6. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Stripe Dashboard**: PaymentIntent –Ω–∞ $1.07

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ (–æ—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞)
1. –í—ã–ø–æ–ª–Ω–∏—Ç—å –°—Ü–µ–Ω–∞—Ä–∏–π 1
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å**: PaymentIntent —Å–æ–∑–¥–∞–Ω –Ω–∞ $1.07
3. –ò–∑–º–µ–Ω–∏—Ç—å —à—Ç–∞—Ç –Ω–∞ Delaware (–±–µ–∑ –Ω–∞–ª–æ–≥–∞)
4. **–û–∂–∏–¥–∞–µ–º–æ**: "Calculating taxes..." ‚Üí "Updating payment amount..." ‚Üí "Payment ready"
5. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Stripe Dashboard**: —Ç–æ—Ç –∂–µ PaymentIntent –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ $1.00

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ
1. –í—ã–ø–æ–ª–Ω–∏—Ç—å –°—Ü–µ–Ω–∞—Ä–∏–π 1
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å**: PaymentIntent —Å–æ–∑–¥–∞–Ω –Ω–∞ $1.07
3. –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä –∑–∞ $2.00
4. **–û–∂–∏–¥–∞–µ–º–æ**: PaymentIntent —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è, —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π –Ω–∞ $3.21 (—Å –Ω–∞–ª–æ–≥–æ–º)

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π –∞–¥—Ä–µ—Å
1. –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –∑–∞ $1.00
2. –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–¥—Ä–µ—Å –≤ Canada
3. **–û–∂–∏–¥–∞–µ–º–æ**: –Ω–∞–ª–æ–≥ 0%, PaymentIntent –Ω–∞ $1.00

### –°—Ü–µ–Ω–∞—Ä–∏–π 5: –ë—ã—Å—Ç—Ä–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞
1. –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –∑–∞ $1.00
2. –ë—ã—Å—Ç—Ä–æ –º–µ–Ω—è—Ç—å —à—Ç–∞—Ç—ã: CA ‚Üí NY ‚Üí TX ‚Üí FL
3. **–û–∂–∏–¥–∞–µ–º–æ**: —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å debounce –∏ –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ª–∏—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
```bash
# –û—Ç–∫—Ä—ã—Ç—å DevTools ‚Üí Console
# –ò—Å–∫–∞—Ç—å –ª–æ–≥–∏:
# - "Creating PaymentIntent:"
# - "PaymentIntent created successfully:"
# - "Updating PaymentIntent due to tax change:"
# - "PaymentIntent updated successfully:"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ Stripe Dashboard
```bash
# 1. –í–æ–π—Ç–∏ –≤ https://dashboard.stripe.com/
# 2. –ü–µ—Ä–µ–π—Ç–∏ –≤ Payments
# 3. –ù–∞–π—Ç–∏ PaymentIntent –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è
# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Amount –∏ Metadata
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–∫–∞–∑—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Å—É–º–º–∞–º–∏
SELECT 
  id,
  total_amount,
  tax_amount,
  payment_intent_id,
  created_at
FROM orders 
ORDER BY created_at DESC 
LIMIT 5;
```

## –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### ‚úÖ –ß—Ç–æ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å
1. PaymentIntent —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞ –Ω–∞–ª–æ–≥–æ–≤
2. –°—É–º–º–∞ –≤ Stripe = —Å—É–º–º–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ = —Å—É–º–º–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
3. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∞–¥—Ä–µ—Å–∞ PaymentIntent –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
4. –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
5. –ù–µ—Ç –ª–∏—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Stripe API

### ‚ùå –ß—Ç–æ –ù–ï –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å
1. PaymentIntent –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –¥–æ —Ä–∞—Å—á–µ—Ç–∞ –Ω–∞–ª–æ–≥–æ–≤
2. –ù–µ—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –º–µ–∂–¥—É –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–π –∏ —Å–ø–∏—Å—ã–≤–∞–µ–º–æ–π —Å—É–º–º–æ–π
3. –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è PaymentIntent –ø—Ä–∏ –±—ã—Å—Ç—Ä—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
4. –ù–µ—Ç –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∞–¥—Ä–µ—Å–∞

## –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### –£—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ PaymentIntent
```
PaymentIntent creation conditions met: {
  cartLoading: false,
  itemsLength: 1,
  hasClientSecret: false,
  isCalculating: false,
  hasCompleteAddress: true,
  country: "US",
  hasState: true,
  taxAmount: 0.07
}

Creating PaymentIntent: {
  subtotal: 1,
  taxAmount: 0.07,
  totalWithTax: 1.07,
  amountInCents: 107,
  itemCount: 1
}

PaymentIntent created successfully: {
  paymentIntentId: "pi_...",
  amount: 107,
  taxAmount: 7
}
```

### –£—Å–ø–µ—à–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ PaymentIntent
```
Updating PaymentIntent due to tax change: {
  paymentIntentId: "pi_...",
  oldAmount: 107,
  newAmount: 100,
  taxAmount: 0
}

PaymentIntent updated successfully: {
  paymentIntentId: "pi_...",
  newAmount: 100,
  taxAmount: 0
}
```

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

1. ‚úÖ **–¢–æ—á–Ω–æ—Å—Ç—å —Å—É–º–º**: Stripe Dashboard –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—É–º–º—É
2. ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: PaymentIntent –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∞–¥—Ä–µ—Å–∞
3. ‚úÖ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç**: –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ù–µ—Ç –ª–∏—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
5. ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –û–±—Ä–∞–±–æ—Ç–∫–∞ edge cases —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. –ï—Å–ª–∏ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ ‚Üí —Ä–µ—à–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É
2. –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã ‚Üí –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
3. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ